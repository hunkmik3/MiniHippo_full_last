<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from aptiskey.com/listening_question16_17.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 07 Nov 2025 10:17:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm thẻ này -->
    <title>Mini Hippo - Listening Practice</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/listeningkey.css" rel="stylesheet">
    <link href="css/lesson-ui.css" rel="stylesheet">
    <style>
        body.lesson-loading #question16 { opacity: 0; pointer-events: none; }
        body.lesson-loading #question16 * { visibility: hidden; }
        #question16.lesson-loading { opacity: 0; pointer-events: none; }
        #question16.lesson-loading * { visibility: hidden; }
        #lesson-loading-indicator {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: white; padding: 30px 50px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); text-align: center; display: none;
        }
        body.lesson-loading #lesson-loading-indicator { display: block; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 18px; color: #333; font-weight: 500; }
    </style>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('lesson')) {
                const style = document.createElement('style');
                style.id = 'lesson-loading-style';
                style.textContent = '#question16 { opacity: 0 !important; pointer-events: none !important; } #question16 * { visibility: hidden !important; }';
                document.head.appendChild(style);
                window._lessonLoadingStyle = style;
                if (document.body) {
                    document.body.classList.add('lesson-loading');
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.classList.add('lesson-loading');
                    });
                }
            }
        })();
    </script>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const lessonId = urlParams.get('lesson');
            const part = 'listening_16_17';
            let lessonScriptLoaded = false;
            
            function setLoadingState(isLoading) {
                if (document.body) {
                    if (isLoading) document.body.classList.add('lesson-loading');
                    else document.body.classList.remove('lesson-loading');
                }
                const questionContainer = document.getElementById('question16');
                if (questionContainer) {
                    if (isLoading) questionContainer.classList.add('lesson-loading');
                    else questionContainer.classList.remove('lesson-loading');
                }
                if (!isLoading) {
                    const loadingStyle = document.getElementById('lesson-loading-style');
                    if (loadingStyle) loadingStyle.remove();
                    if (window._lessonLoadingStyle && window._lessonLoadingStyle.parentNode) {
                        window._lessonLoadingStyle.remove();
                    }
                }
            }
            
            if (lessonId) {
                if (document.body) setLoadingState(true);
                else {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() { setLoadingState(true); });
                    } else setLoadingState(true);
                }
            }
            
            async function loadLessonScript() {
                if (!lessonId) {
                    console.log('No lesson parameter - trying to load latest uploaded lesson');
                    try {
                        const listResponse = await fetch(`/api/lessons/list?part=listening_16_17`);
                        const listResult = await listResponse.json();
                        if (listResult.success && listResult.lessons && listResult.lessons.length > 0) {
                            const latestLesson = listResult.lessons[0]; // First one is latest (ordered by created_at.desc)
                            console.log('Found latest lesson, loading:', latestLesson.id);
                            // Redirect to same page with lesson ID
                            window.location.href = `${window.location.pathname}?lesson=${latestLesson.id}`;
                            return;
                        } else {
                            console.log('No uploaded lessons found - loading default/original lesson');
                            loadDefaultScript();
                            return;
                        }
                    } catch (error) {
                        console.error('Error fetching latest lesson:', error);
                        console.log('Falling back to default/original lesson');
                    loadDefaultScript();
                    return;
                    }
                }
                
                try {
                    console.log('Loading lesson with ID:', lessonId);
                    const response = await fetch(`/api/lessons/get?id=${lessonId}`);
                    const result = await response.json();
                    console.log('Lesson data response:', result);
                    
                    if (response.ok && result.lesson) {
                        const lesson = result.lesson;
                        console.log('Lesson found:', lesson);
                        
                        const scriptResponse = await fetch(`/api/lessons/get-script-url?filePath=${encodeURIComponent(lesson.file_path)}`);
                        const scriptResult = await scriptResponse.json();
                        console.log('Script URL response:', scriptResult);
                        
                        const scriptPath = `/api/lessons/get-script?filePath=${encodeURIComponent(lesson.file_path)}&v=${new Date().getTime()}`;
                        console.log('Fetching script content from API proxy:', scriptPath);
                        
                        try {
                            const scriptResponse = await fetch(scriptPath);
                            if (!scriptResponse.ok) throw new Error(`Failed to fetch script: ${scriptResponse.status}`);
                            
                            const scriptContent = await scriptResponse.text();
                            console.log('Script content fetched, executing...');
                            
                            let modifiedContent = scriptContent;
                            if (document.readyState !== 'loading') {
                                console.log('DOM already ready, replacing DOMContentLoaded with immediate execution');
                                modifiedContent = scriptContent.replace(
                                    /document\.addEventListener\(['"]DOMContentLoaded['"],\s*function\(\)\s*\{/g,
                                    '(function() {'
                                );
                                const lastMatch = modifiedContent.lastIndexOf('});');
                                if (lastMatch !== -1 && modifiedContent !== scriptContent) {
                                    modifiedContent = modifiedContent.substring(0, lastMatch) + '})();' + modifiedContent.substring(lastMatch + 3);
                                }
                            } else console.log('DOM still loading, keeping DOMContentLoaded listener');
                            
                            const scriptElement = document.createElement('script');
                            scriptElement.textContent = modifiedContent;
                            document.head.appendChild(scriptElement);
                            
                            // After script execution, manually call renderQuestion16 if it exists
                            setTimeout(function() {
                                function checkAndRender() {
                                    // Check in both global and window scope
                                    const q16Data = window.question16Data || (typeof question16Data !== 'undefined' ? question16Data : null);
                                    const renderFn = window.renderQuestion16 || (typeof renderQuestion16 !== 'undefined' ? renderQuestion16 : null);
                                    
                                    console.log('Checking for question16Data:', {
                                        windowQuestion16Data: typeof window.question16Data,
                                        question16Data: typeof question16Data,
                                        windowRenderQuestion16: typeof window.renderQuestion16,
                                        renderQuestion16: typeof renderQuestion16,
                                        q16DataLength: q16Data ? q16Data.length : 'N/A'
                                    });
                                    
                                    if (q16Data && q16Data.length > 0 && renderFn) {
                                        console.log('Found question16Data and renderQuestion16, calling render...');
                                        try {
                                            renderFn(q16Data[0]);
                                setLoadingState(false);
                                const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                if (loadingIndicator) loadingIndicator.style.display = 'none';
                                            lessonScriptLoaded = true;
                                            console.log('Question 16 rendered successfully');
                                            return true;
                                        } catch (error) {
                                            console.error('Error calling renderQuestion16:', error);
                                        }
                                    }
                                    return false;
                                }
                                
                                // Try multiple times with increasing delays
                                let attempts = 0;
                                const maxAttempts = 30;
                                
                                function tryRender() {
                                    attempts++;
                                    console.log(`Attempt ${attempts} to find and render question16Data...`);
                                    
                                    if (checkAndRender()) {
                                        // Success, already handled in checkAndRender
                                    } else if (attempts < maxAttempts) {
                                        setTimeout(tryRender, 150);
                                    } else {
                                        console.error('Failed to render question16Data after', maxAttempts, 'attempts');
                                        console.log('Available globals:', Object.keys(window).filter(k => k.includes('question') || k.includes('16')));
                                        setLoadingState(false);
                                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                                    lessonScriptLoaded = true;
                                    }
                                }
                                
                                tryRender();
                            }, 200);
                            
                            return;
                        } catch (error) {
                            console.error('Failed to fetch/execute script from API proxy:', error);
                            setLoadingState(false);
                            const loadingIndicator = document.getElementById('lesson-loading-indicator');
                            if (loadingIndicator) loadingIndicator.style.display = 'none';
                            if (scriptResponse.ok && scriptResult.scriptUrl) {
                                console.log('Trying GitHub raw URL fallback...');
                                const rawScript = document.createElement('script');
                                rawScript.src = scriptResult.scriptUrl + '?v=' + new Date().getTime();
                                rawScript.defer = true;
                                rawScript.onload = function() {
                                    setLoadingState(false);
                                    const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                                };
                                rawScript.onerror = function() {
                                    console.error('GitHub raw URL also failed, trying local...');
                                    const localPath = lesson.file_path;
                                    const localScript = document.createElement('script');
                                    localScript.src = (localPath.startsWith('js/') ? localPath : 'js/' + localPath) + '?v=' + new Date().getTime();
                                    localScript.defer = true;
                                    localScript.onload = function() {
                                        setLoadingState(false);
                                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                                    };
                                    localScript.onerror = function() {
                                        console.error('All methods failed, loading default');
                                        setLoadingState(false);
                                        loadDefaultScript();
                                    };
                                    document.head.appendChild(localScript);
                                };
                                document.head.appendChild(rawScript);
                                return;
                            } else {
                                console.log('Loading default script');
                                loadDefaultScript();
                                return;
                            }
                        }
                    } else {
                        console.error('Lesson not found or error:', result);
                        setLoadingState(false);
                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        console.log('Lesson not found, loading default script');
                        loadDefaultScript();
                    }
                } catch (error) {
                    console.error('Error loading lesson:', error);
                    setLoadingState(false);
                    const loadingIndicator = document.getElementById('lesson-loading-indicator');
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    console.log('Error loading lesson, loading default script');
                    loadDefaultScript();
                }
            }
            
            function loadDefaultScript() {
                console.log('loadDefaultScript called, DOM readyState:', document.readyState);
                const scriptUrl = 'js/listening_question/listening_question16_17.js?v=' + new Date().getTime();
                console.log('Fetching script content directly');
                fetch(scriptUrl)
                        .then(response => {
                            console.log('Fetch response status:', response.status);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.text();
                        })
                        .then(scriptContent => {
                            console.log('Script content fetched, length:', scriptContent.length);
                            let modifiedContent = scriptContent.replace(
                                /document\.addEventListener\(['"]DOMContentLoaded['"],\s*function\(\)\s*\{/g,
                                '(function() {'
                            );
                            const lastMatch = modifiedContent.lastIndexOf('});');
                            if (lastMatch !== -1 && modifiedContent !== scriptContent) {
                                modifiedContent = modifiedContent.substring(0, lastMatch) + '})();' + modifiedContent.substring(lastMatch + 3);
                                console.log('Replaced DOMContentLoaded with IIFE');
                            } else console.log('No DOMContentLoaded found, using script as-is');
                            const scriptElement = document.createElement('script');
                            scriptElement.textContent = modifiedContent;
                            scriptElement.onerror = function(error) { console.error('Error executing script:', error); };
                            document.head.appendChild(scriptElement);
                            console.log('Default script executed successfully');
                            setTimeout(function() {
                                const container = document.getElementById('question16');
                                if (container && container.innerHTML.trim().length > 100) {
                                    console.log('Content rendered successfully');
                                } else console.warn('Content not rendered yet, container:', container);
                            }, 500);
                        })
                        .catch(error => {
                            console.error('Failed to fetch/execute default script:', error);
                            console.log('Trying fallback: normal script loading');
                            const script = document.createElement('script');
                            script.src = scriptUrl;
                            script.defer = true;
                            script.onload = function() { console.log('Fallback script loaded'); };
                            script.onerror = function() { console.error('Fallback script also failed'); };
                            document.head.appendChild(script);
                        });
            }
            
            loadLessonScript();
        })();
    </script>
</head>

<body>
<!-- Loading Indicator -->
<div id="lesson-loading-indicator">
    <div class="loading-spinner"></div>
    <div class="loading-text">Đang tải bài học...</div>
</div>
<!-- ====================================================================================
                  HEADER SECTION
======================================================================================== -->
<div class="header d-flex justify-content-between align-items-center p-3 bg-white text-dark shadow-sm">
  <!-- Left Section -->
  <div class="d-flex align-items-center">
    <a href="listening_question.html" class="me-3 text-decoration-none text-dark fs-4">
      <i class="bi bi-house-door-fill me-2"></i> <!-- Example icon from Bootstrap Icons -->
      <span>Mini Hippo</span>
    </a>
  </div>

  <!-- Center Section (Countdown Timer) -->
  <div class="d-flex align-items-center">
    <span class="time-remaining-label me-2 fs-6">Time remaining:</span>
    <span class="countdown fs-4" id="countdownTimer">34:00</span>
  </div>

  <!-- Right Section (Current Step) -->
  <div id="question_step" class="fs-5 fw-bold">
    Question 16 & 17
  </div>
</div>

<!-- ====================================================================================
                  Question 16 (Question 16 of 17)
======================================================================================== -->

<!-- Wrapper Container -->
<div id="question16" class="container py-5">
  <h3 class="mb-4"><strong id="question16_id">Question 16 of 17</strong></h3>

  <!-- Top Red Bar -->
  <div class="top-bar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <!-- Nút play -->
      <button id="playButton16" class="btn btn-link text-white p-0">
        <i id="playIcon16" class="bi bi-play-fill fs-4"></i>
      </button>

      <button class="btn btn-link text-white p-0">
        <i class="bi bi-volume-up-fill fs-5"></i>
      </button>

      <input type="range" class="form-range" />
    </div>
    <div>
      <small id="playCountLabel16">2 of 2 plays remaining</small>
    </div>

    <!-- Audio ẩn -->
    <audio id="audioPlayer16" preload="none"></audio>
  </div>

  <!-- Question and Options -->
  <div class="question-container">
    <h5 class="mb-4"><strong id="question16_topic">Topic: Environmental Concerns</strong></h5>

    <!-- Câu hỏi 16.1 -->
    <div class="mb-4">
      <label id="q16_opinion1_label" class="form-label mb-0">16.1 What is his overall opinion?</label>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion1" id="opinion1_A" value="A">
        <label class="form-check-label" for="opinion1_A"></label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion1" id="opinion1_B" value="B">
        <label class="form-check-label" for="opinion1_B"></label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion1" id="opinion1_C" value="C">
        <label class="form-check-label" for="opinion1_C"></label>
      </div>
    </div>

    <!-- Câu hỏi 16.2 -->
    <div class="mb-4">
      <label id="q16_opinion2_label" class="form-label mb-0">16.2 What is his prediction for natural disasters?</label>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion2" id="opinion2_A" value="A">
        <label class="form-check-label" for="opinion2_A"></label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion2" id="opinion2_B" value="B">
        <label class="form-check-label" for="opinion2_B"></label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opinion2" id="opinion2_C" value="C">
        <label class="form-check-label" for="opinion2_C"></label>
      </div>
    </div>
  </div>

  <!-- Show Transcript Button -->
  <div class="mt-3">
    <button id="showTranscriptButton16" class="btn btn-primary">Show Paragraph</button>
  </div>

  <!-- Transcript Content (Hidden by default) -->
  <div id="transcriptBox16" class="card mt-3" style="display: none;">
    <div class="card-body">
      <p><strong>Paragraph:</strong></p>
      <p id="transcriptContent16"></p>
    </div>
  </div>
</div>




<!-- ============================================ 
                  Modal for Test Result
================================================ -->
<!-- Modal for Test Result -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultModalLabel">Test and Answer Review for Question 16</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h5 id="totalScore"></h5> <!-- Hiển thị điểm tổng -->
        <h5 id="scoreClassification"></h5> <!-- Hiển thị phân loại điểm -->

        <!-- Bảng so sánh kết quả -->
        <table class="table table-bordered mt-4">
          <thead>
            <tr>
              <th scope="col">Your Answer</th>
              <th scope="col">Correct Answer</th>
            </tr>
          </thead>
          <tbody id="comparisonTableBody">
            <!-- Các kết quả so sánh sẽ được hiển thị tại đây -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- ============================================
                  FOOTER SECTION
================================================ -->
  <div class="footer">
    <button class="btn btn-back" id="backButton">Back</button>
     <button class="btn btn-check-result" id="checkResultButton">Check result</button>
    <button class="btn btn-next" id="nextButton">Next</button>
  </div>

