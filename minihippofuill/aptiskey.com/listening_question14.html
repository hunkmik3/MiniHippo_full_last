<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from aptiskey.com/listening_question14.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 07 Nov 2025 10:17:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm thẻ này -->
    <title>Mini Hippo - Listening Practice</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/listeningkey.css" rel="stylesheet">
    <link href="css/lesson-ui.css" rel="stylesheet">
    <style>
        /* Hide content initially when loading lesson script */
        body.lesson-loading #question14 {
            opacity: 0;
            pointer-events: none;
        }
        body.lesson-loading #question14 * {
            visibility: hidden;
        }
        /* Hide by default if lesson parameter exists */
        #question14.lesson-loading {
            opacity: 0;
            pointer-events: none;
        }
        #question14.lesson-loading * {
            visibility: hidden;
        }
        
        /* Loading indicator styles */
        #lesson-loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            display: none;
        }
        
        body.lesson-loading #lesson-loading-indicator {
            display: block;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #333;
            font-weight: 500;
        }
    </style>
    <script>
        // Check for lesson parameter and add inline style to hide content immediately
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('lesson')) {
                const style = document.createElement('style');
                style.id = 'lesson-loading-style';
                style.textContent = '#question14 { opacity: 0 !important; pointer-events: none !important; } #question14 * { visibility: hidden !important; }';
                document.head.appendChild(style);
                window._lessonLoadingStyle = style;
                if (document.body) {
                    document.body.classList.add('lesson-loading');
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.classList.add('lesson-loading');
                    });
                }
            }
        })();
    </script>
    <script>
        // Dynamic JS loading based on lesson ID parameter
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const lessonId = urlParams.get('lesson');
            const part = 'listening_14';
            let lessonScriptLoaded = false;
            
            function setLoadingState(isLoading) {
                if (document.body) {
                    if (isLoading) {
                        document.body.classList.add('lesson-loading');
                    } else {
                        document.body.classList.remove('lesson-loading');
                    }
                }
                const questionContainer = document.getElementById('question14');
                if (questionContainer) {
                    if (isLoading) {
                        questionContainer.classList.add('lesson-loading');
                    } else {
                        questionContainer.classList.remove('lesson-loading');
                    }
                }
                if (!isLoading) {
                    const loadingStyle = document.getElementById('lesson-loading-style');
                    if (loadingStyle) loadingStyle.remove();
                    if (window._lessonLoadingStyle && window._lessonLoadingStyle.parentNode) {
                        window._lessonLoadingStyle.remove();
                    }
                }
            }
            
            if (lessonId) {
                if (document.body) {
                    setLoadingState(true);
                } else {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            setLoadingState(true);
                        });
                    } else {
                        setLoadingState(true);
                    }
                }
            }
            
            async function loadLessonScript() {
                if (!lessonId) {
                    console.log('No lesson parameter - trying to load latest uploaded lesson');
                    try {
                        const listResponse = await fetch(`/api/lessons/list?part=listening_14`);
                        const listResult = await listResponse.json();
                        if (listResult.success && listResult.lessons && listResult.lessons.length > 0) {
                            const latestLesson = listResult.lessons[0]; // First one is latest (ordered by created_at.desc)
                            console.log('Found latest lesson, loading:', latestLesson.id);
                            // Redirect to same page with lesson ID
                            window.location.href = `${window.location.pathname}?lesson=${latestLesson.id}`;
                            return;
                        } else {
                            console.log('No uploaded lessons found - loading default/original lesson');
                            loadDefaultScript();
                            return;
                        }
                    } catch (error) {
                        console.error('Error fetching latest lesson:', error);
                        console.log('Falling back to default/original lesson');
                    loadDefaultScript();
                    return;
                    }
                }
                
                try {
                    console.log('Loading lesson with ID:', lessonId);
                    const response = await fetch(`/api/lessons/get?id=${lessonId}`);
                    const result = await response.json();
                    console.log('Lesson data response:', result);
                    
                    if (response.ok && result.lesson) {
                        const lesson = result.lesson;
                        console.log('Lesson found:', lesson);
                        
                        const scriptResponse = await fetch(`/api/lessons/get-script-url?filePath=${encodeURIComponent(lesson.file_path)}`);
                        const scriptResult = await scriptResponse.json();
                        console.log('Script URL response:', scriptResult);
                        
                        const scriptPath = `/api/lessons/get-script?filePath=${encodeURIComponent(lesson.file_path)}&v=${new Date().getTime()}`;
                        console.log('Fetching script content from API proxy:', scriptPath);
                        
                        try {
                            const scriptResponse = await fetch(scriptPath);
                            if (!scriptResponse.ok) {
                                throw new Error(`Failed to fetch script: ${scriptResponse.status}`);
                            }
                            
                            const scriptContent = await scriptResponse.text();
                            console.log('Script content fetched, executing...');
                            
                            let modifiedContent = scriptContent;
                            if (document.readyState !== 'loading') {
                                console.log('DOM already ready, replacing DOMContentLoaded with immediate execution');
                                modifiedContent = scriptContent.replace(
                                    /document\.addEventListener\(['"]DOMContentLoaded['"],\s*function\(\)\s*\{/g,
                                    '(function() {'
                                );
                                const lastMatch = modifiedContent.lastIndexOf('});');
                                if (lastMatch !== -1 && modifiedContent !== scriptContent) {
                                    modifiedContent = modifiedContent.substring(0, lastMatch) + '})();' + modifiedContent.substring(lastMatch + 3);
                                }
                            } else {
                                console.log('DOM still loading, keeping DOMContentLoaded listener');
                            }
                            
                            const scriptElement = document.createElement('script');
                            scriptElement.textContent = modifiedContent;
                            document.head.appendChild(scriptElement);
                            
                            // After script execution, manually call renderQuestion14 if it exists
                            setTimeout(function() {
                                function checkAndRender() {
                                    // Check in both global and window scope
                                    const q14Data = window.question14Data || (typeof question14Data !== 'undefined' ? question14Data : null);
                                    const renderFn = window.renderQuestion14 || (typeof renderQuestion14 !== 'undefined' ? renderQuestion14 : null);
                                    
                                    console.log('Checking for question14Data:', {
                                        windowQuestion14Data: typeof window.question14Data,
                                        question14Data: typeof question14Data,
                                        windowRenderQuestion14: typeof window.renderQuestion14,
                                        renderQuestion14: typeof renderQuestion14,
                                        q14DataLength: q14Data ? q14Data.length : 'N/A'
                                    });
                                    
                                    if (q14Data && q14Data.length > 0 && renderFn) {
                                        console.log('Found question14Data and renderQuestion14, calling render...');
                                        try {
                                            renderFn(q14Data[0]);
                                setLoadingState(false);
                                const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                if (loadingIndicator) loadingIndicator.style.display = 'none';
                                            lessonScriptLoaded = true;
                                            console.log('Question 14 rendered successfully');
                                            return true;
                                        } catch (error) {
                                            console.error('Error calling renderQuestion14:', error);
                                        }
                                    }
                                    return false;
                                }
                                
                                // Try multiple times with increasing delays
                                let attempts = 0;
                                const maxAttempts = 30;
                                
                                function tryRender() {
                                    attempts++;
                                    console.log(`Attempt ${attempts} to find and render question14Data...`);
                                    
                                    if (checkAndRender()) {
                                        // Success, already handled in checkAndRender
                                    } else if (attempts < maxAttempts) {
                                        setTimeout(tryRender, 150);
                                    } else {
                                        console.error('Failed to render question14Data after', maxAttempts, 'attempts');
                                        console.log('Available globals:', Object.keys(window).filter(k => k.includes('question') || k.includes('14')));
                                        setLoadingState(false);
                                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                                    lessonScriptLoaded = true;
                                    }
                                }
                                
                                tryRender();
                            }, 200);
                            
                            return;
                        } catch (error) {
                            console.error('Failed to fetch/execute script from API proxy:', error);
                            setLoadingState(false);
                            const loadingIndicator = document.getElementById('lesson-loading-indicator');
                            if (loadingIndicator) loadingIndicator.style.display = 'none';
                            if (scriptResponse.ok && scriptResult.scriptUrl) {
                                console.log('Trying GitHub raw URL fallback...');
                                const rawScript = document.createElement('script');
                                rawScript.src = scriptResult.scriptUrl + '?v=' + new Date().getTime();
                                rawScript.defer = true;
                                rawScript.onload = function() {
                                    setLoadingState(false);
                                    const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                                };
                                rawScript.onerror = function() {
                                    console.error('GitHub raw URL also failed, trying local...');
                                    const localPath = lesson.file_path;
                                    const localScript = document.createElement('script');
                                    localScript.src = (localPath.startsWith('js/') ? localPath : 'js/' + localPath) + '?v=' + new Date().getTime();
                                    localScript.defer = true;
                                    localScript.onload = function() {
                                        setLoadingState(false);
                                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                                    };
                                    localScript.onerror = function() {
                                        console.error('All methods failed, loading default');
                                        setLoadingState(false);
                                        loadDefaultScript();
                                    };
                                    document.head.appendChild(localScript);
                                };
                                document.head.appendChild(rawScript);
                                return;
                            } else {
                                console.log('Loading default script');
                                loadDefaultScript();
                                return;
                            }
                        }
                    } else {
                        console.error('Lesson not found or error:', result);
                        setLoadingState(false);
                        const loadingIndicator = document.getElementById('lesson-loading-indicator');
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        console.log('Lesson not found, loading default script');
                        loadDefaultScript();
                    }
                } catch (error) {
                    console.error('Error loading lesson:', error);
                    setLoadingState(false);
                    const loadingIndicator = document.getElementById('lesson-loading-indicator');
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    console.log('Error loading lesson, loading default script');
                    loadDefaultScript();
                }
            }
            
            function loadDefaultScript() {
                console.log('loadDefaultScript called, DOM readyState:', document.readyState);
                const scriptUrl = 'js/listening_question/listening_question14.js?v=' + new Date().getTime();
                console.log('Fetching script content directly');
                fetch(scriptUrl)
                        .then(response => {
                            console.log('Fetch response status:', response.status);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(scriptContent => {
                            console.log('Script content fetched, length:', scriptContent.length);
                            let modifiedContent = scriptContent.replace(
                                /document\.addEventListener\(['"]DOMContentLoaded['"],\s*function\(\)\s*\{/g,
                                '(function() {'
                            );
                            const lastMatch = modifiedContent.lastIndexOf('});');
                            if (lastMatch !== -1 && modifiedContent !== scriptContent) {
                                modifiedContent = modifiedContent.substring(0, lastMatch) + '})();' + modifiedContent.substring(lastMatch + 3);
                                console.log('Replaced DOMContentLoaded with IIFE');
                            } else {
                                console.log('No DOMContentLoaded found, using script as-is');
                            }
                            const scriptElement = document.createElement('script');
                            scriptElement.textContent = modifiedContent;
                            scriptElement.onerror = function(error) {
                                console.error('Error executing script:', error);
                            };
                            document.head.appendChild(scriptElement);
                            console.log('Default script executed successfully');
                            setTimeout(function() {
                                const container = document.getElementById('question14');
                                if (container && container.innerHTML.trim().length > 100) {
                                    console.log('Content rendered successfully');
                                } else {
                                    console.warn('Content not rendered yet, container:', container);
                                }
                            }, 500);
                        })
                        .catch(error => {
                            console.error('Failed to fetch/execute default script:', error);
                            console.log('Trying fallback: normal script loading');
                            const script = document.createElement('script');
                            script.src = scriptUrl;
                            script.defer = true;
                            script.onload = function() {
                                console.log('Fallback script loaded');
                            };
                            script.onerror = function() {
                                console.error('Fallback script also failed');
                            };
                            document.head.appendChild(script);
                        });
            }
            
            loadLessonScript();
        })();
    </script>
</head>

<body>
<!-- Loading Indicator -->
<div id="lesson-loading-indicator">
    <div class="loading-spinner"></div>
    <div class="loading-text">Đang tải bài học...</div>
</div>
<!-- ====================================================================================
                  HEADER SECTION
======================================================================================== -->
<div class="header d-flex justify-content-between align-items-center p-3 bg-white text-dark shadow-sm">
  <!-- Left Section -->
  <div class="d-flex align-items-center">
    <a href="listening_question.html" class="me-3 text-decoration-none text-dark fs-4">
      <i class="bi bi-house-door-fill me-2"></i> <!-- Example icon from Bootstrap Icons -->
      <span>Mini Hippo</span>
    </a>
  </div>

  <!-- Center Section (Countdown Timer) -->
  <div class="d-flex align-items-center">
    <span class="time-remaining-label me-2 fs-6">Time remaining:</span>
    <span class="countdown fs-4" id="countdownTimer">34:00</span>
  </div>

  <!-- Right Section (Current Step) -->
  <div id="question_step" class="fs-5 fw-bold">
    Question 14
  </div>
</div>

<!-- ====================================================================================
                  Question 2 (Question 14 of 17)
======================================================================================== -->

<!-- Wrapper Container -->
<div id="question14" class="container py-5">
  <h3 class="mb-4"><strong id="question2_id">Question 1</strong></h3>

  <!-- Top Red Bar -->
  <div class="top-bar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <button id="playButton2" class="btn btn-link text-white p-0">
        <i id="playIcon2" class="bi bi-play-fill fs-4"></i>
      </button>

      <button class="btn btn-link text-white p-0">
        <i class="bi bi-volume-up-fill fs-5"></i>
      </button>

      <input type="range" class="form-range" />
    </div>
    <div>
      <small id="playCountLabel2">2 of 2 plays remaining</small>
    </div>

    <audio id="audioPlayer2" preload="none"></audio>
  </div>

  <!-- Question and Options -->
  <div class="question-container">
    <h5 class="mb-4"><strong id="question14_topic">Topic: Shopping</strong></h5>
<p class="mb-4" id="question14_topic">Four people are discussing their views on the topic above. Complete the sentences. Use each answer only once. You will not need two of the answers.</p>
    <div class="d-flex align-items-center mb-3 gap-3">
      <label for="person1" class="form-label mb-0" style="width: 80px;">Person 1</label>
      <select id="person1" class="form-select" style="border: 1px solid #cccc99; ">
        <option value="">-- Select an answer --</option>
      </select>
    </div>

    <div class="d-flex align-items-center mb-3 gap-3">
      <label for="person2" class="form-label mb-0" style="width: 80px;">Person 2</label>
      <select id="person2" class="form-select" style="border: 1px solid #cccc99; ">
        <option value="">-- Select an answer --</option>
      </select>
    </div>

    <div class="d-flex align-items-center mb-3 gap-3">
      <label for="person3" class="form-label mb-0" style="width: 80px;">Person 3</label>
      <select id="person3" class="form-select" style="border: 1px solid #cccc99;">
        <option value="">-- Select an answer --</option>
      </select>
    </div>

    <div class="d-flex align-items-center mb-3 gap-3">
      <label for="person4" class="form-label mb-0" style="width: 80px;">Person 4</label>
      <select id="person4" class="form-select" style="border: 1px solid #cccc99;">
        <option value="">-- Select an answer --</option>
      </select>
    </div>
  </div>

  <!-- Show Transcript Button -->
  <div class="mt-3">
    <button id="showTranscriptButton14" class="btn btn-primary">Show Paragraph</button>
  </div>

  <!-- Transcript Content (Hidden by default) -->
  <div id="transcriptBox14" class="card mt-3" style="display: none;">
    <div class="card-body">
      <p><strong>Paragraph:</strong></p>
      <p id="transcriptContent14"></p>
    </div>
  </div>
</div>




<!-- ============================================
                  Kết quả so sánh - câu 14
================================================ -->
<!-- 2. Kết quả so sánh - question 14 -->
<div class="container" id="comparisonResult_question14" style="display: none;">
    <h3>Question 14</h3>
    <p id="totalScore_question14"></p> <!-- Hiển thị điểm tổng -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>STT</th> <!-- Cột thứ tự câu hỏi -->
                <th>Your Answer</th>  <!-- Cột cho đáp án người dùng -->
                <th>Correct Answer</th> <!-- Cột cho đáp án đúng -->
            </tr>
        </thead>
        <tbody id="comparisonBody_question14">
        </tbody>
    </table>
</div>


<!-- ============================================ 
                  Modal for Test Result
================================================ -->
<!-- Modal for Test Result -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultModalLabel">Test and Answer Review question 14</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h5 id="totalScore"></h5> <!-- Hiển thị điểm tổng -->
        <h5 id="scoreClassification"></h5> <!-- Hiển thị phân loại điểm -->

        <!-- Bảng so sánh kết quả -->
        <table class="table table-bordered mt-4">
          <thead>
            <tr>
              <th scope="col">Your Answer</th>
              <th scope="col">Correct Answer</th>
            </tr>
          </thead>
          <tbody id="comparisonTableBody">
            <!-- Các kết quả so sánh sẽ được hiển thị tại đây -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>




<!-- ============================================
                  FOOTER SECTION
================================================ -->
  <div class="footer">
    <button class="btn btn-back" id="backButton">Back</button>
     <button class="btn btn-check-result" id="checkResultButton">Check result</button>
    <button class="btn btn-next" id="nextButton">Next</button>
  </div>
<!-- ============================================
                  POPUP XÁC NHẬN BÀI THI
================================================ -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>