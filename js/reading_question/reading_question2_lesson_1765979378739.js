// ===============================================================================================================
// ////////////// DANH SÁCH CÂU HỎI PART 2 & 3 ///////////////
// ===============================================================================================================

// READING EXTRA P2 - Topic: Đề dự phòng thêm: Tech Innovation Expo
const question2Content_1 = [
    'The tech expo was held on Sunday morning, showcasing cutting-edge innovations.',
    'Over 75 participants attended, with Ms. Tran presenting a smart home device.',
    'After the presentations, awards were given for the most creative prototype.',
    'Activities included 3D printing demos, Al workshops, and virtual reality trials.',
    'Attendees enjoyed networking over coffee and exploring interactive displays.',
];

// READING EXTRA P2-2 - Topic: Music festivals
const question2Content_2 = [
    '0. Last Saturday, a live music show was held in town park',
    'The local government planned, funded and paid for everything',
    'Because it was free, more than 5,000 people attended',
    'People came early and sat in nearby shops waiting for the start time',
    'The staff were very busy but still closed the shop early to watch the singer',
    'The singer performed for 2 hours, everyone had great fun.',
];

// READING EXTRA P2-3 - Topic: Family sports day
const question2Content_3 = [
    '0. Last week, the weather was great. The town organized a ten-mile race.',
    'It took place on Sunday morning in the park, there was a race for adults.',
    'Sixty people took part, and among them, Ms. Kamus kept the fastest pace and won the race.',
    'After she got her prize, children\'s activities and competitions began.',
    'The activities were football, swimming, skipping, and more, and the kids had fun playing together.',
    'After the games, the kids were really hungry and ate with their parents.',
];

// READING EXTRA P2-4 - Topic: Means of transportation
const question2Content_4 = [
    'In the past, transportation was primarily accessible to the wealthy.',
    'Later, air travel became popular among business professionals.',
    'Eventually, buses and trains were introduced as affordable alternatives.',
    'These made traveling more accessible to everyone.',
    'Today, buses and trains are among the most common transportation options.',
];

// READING EXTRA P2-5 - Topic: A new coffee shop (2)
const question2Content_5 = [
    'I arrived at the shop early in the morning, but it was crowded with people.',
    'A waiter assisted me in finding a table and handed me the menu.',
    'The menu was not as good as expected and quite pricey, so I decided to order a sandwich.',
    'The sandwich was both delicious and beautifully presented.',
    'I might return to try different types of drinks next time.',
];

// READING EXTRA P2-6 - Topic: Making films
const question2Content_6 = [
    '0. In 1895, the Grand Place cafe in France showed the first commercial film.',
    'Old movies were very different from today\'s movies.',
    'That\'s because the movies were only in black and white, and sometimes without sound.',
    'Not only did these technological limitations exist, the movies were also low budget.',
    'Due to the lack of money, actors also had few opportunities to earn money through acting.',
    'Now things have changed, actors and filmmakers can earn millions of dollars from film production.',
];

// READING EXTRA P2-7 - Topic: Tech fair
const question2Content_7 = [
    'The tech fair took place on Saturday morning, showcasing a variety of exciting new gadgets.',
    'More than 60 exhibitors participated, with Mr. A presenting an impressive robot demonstration.',
    'The event featured engaging activities such as VR gaming, coding workshops, and thrilling drone races.',
    'After the demonstrations, awards were given to the creators of the most innovative products.',
    'Visitors enjoyed complimentary coffee and snacks while exploring the interactive exhibits.',
];

// READING EXTRA P2-8 - Topic: The famous singer (2)
const question2Content_8 = [
    'He is a famous singer.',
    'Before becoming famous, he studied music at school when he was 15.',
    'His unique way of dressing and performing made him stand out from others.',
    'This helped him receive many invitations for collaborations and performances.',
    'He eventually became famous among audiences around the world.',
];

// READING EXTRA P2-9 - Topic: The famous singer (3)
const question2Content_9 = [
    'Jaden Nobelton is only 18 years old and he is a famous singer',
    'Before becoming famous at his age, he studied art and music in high school.',
    'During his studies, he studied creativity and singing on stage.',
    'In these performances, he often wears bright clothes and paints his face.',
    'The uniqueness in his way of dressing and his songs makes him attract attention.',
    'Many people follow him on social media and he becomes a famous singer.',
];

// READING EXTRA P2-10 - Topic: Writing about a place (2)
const question2Content_10 = [
    'Before writing, it is important to research the place thoroughly.',
    'To prepare well, you should learn about the people and the history of the area.',
    'Sometimes you may not be able to visit the place, but you can still find similar information from other sources.',
    'Comparing that place with your own country can be very helpful.',
    'This comparison will help you gain a deeper understanding and write more effectively.',
];

// READING EXTRA P2-11 - Topic: My visit to a new coffee shop
const question2Content_11 = [
    'It was my first time visiting a new local coffee shop.',
    'At first, I didn’t think it would be good, but I decided to give it a try.',
    'I looked at the menu and saw many different kinds of food and drinks.',
    'I chose one dish to try for myself.',
    'When I tasted it, I found it really delicious and knew I would come back again.',
];

// READING EXTRA P2-12 - Topic: History to travel
const question2Content_12 = [
    'In the past, only very rich people could afford to travel long distances.',
    'The invention of cars and trains had changed everything and made travelling cheaper.',
    'After these two means of transport, travelling becomes even easier with aeroplanes.',
    'Because flying with them is so fast, more people now go abroad for holiday and business.',
    'It is more convenient to travel to other part of the world due to the improvement in transports',
];

// READING EXTRA P2-13 - Topic: University open day
const question2Content_13 = [
    'Before the open day, please contact us by phone or email so we can record your personal details.',
    'Using this information, we’ll prepare an identification card for you to collect upon arrival.',
    'You’ll need to show this card to enter the introductory talk and morning lectures.',
    'Every visitor will have the chance to join a Q&A session with current students.',
    'After the presentations, you’ll be able to explore different departments across the campus.',
];

const questionSets = [
    question2Content_1,
    question2Content_2,
    question2Content_3,
    question2Content_4,
    question2Content_5,
    question2Content_6,
    question2Content_7,
    question2Content_8,
    question2Content_9,
    question2Content_10,
    question2Content_11,
    question2Content_12,
    question2Content_13,
];

window.questionSets = questionSets;

const questheader1 = {
    question2Content_1: "Đề dự phòng thêm: Tech Innovation Expo",
    question2Content_2: "Music festivals",
    question2Content_3: "Family sports day",
    question2Content_4: "Means of transportation",
    question2Content_5: "A new coffee shop (2)",
    question2Content_6: "Making films",
    question2Content_7: "Tech fair",
    question2Content_8: "The famous singer (2)",
    question2Content_9: "The famous singer (3)",
    question2Content_10: "Writing about a place (2)",
    question2Content_11: "My visit to a new coffee shop",
    question2Content_12: "History to travel",
    question2Content_13: "University open day",
};

function getQuestHeaders(obj) {
    return Object.values(obj);
}

const questheader = getQuestHeaders(questheader1);
window.questionSets = questionSets;
window.questheader = questheader;

let currentSetIndex = 0;
let correctAnswersQuestion2 = [];

function shuffleQuestions(questions) {
  for (let i = questions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [questions[i], questions[j]] = [questions[j], questions[i]];
  }
  return questions;
}

function initSortable() {
  const cardsContainer = document.getElementById('cardsContainer');
  if (!cardsContainer) {
    console.error('cardsContainer not found');
    return;
  }
  // Check if Sortable is available
  if (typeof Sortable === 'undefined') {
    console.error('SortableJS is not loaded. Please ensure sortablejs library is included.');
    // Try to wait a bit and retry
    setTimeout(function() {
      if (typeof Sortable !== 'undefined') {
        initSortable();
      } else {
        console.error('SortableJS still not available after retry');
      }
    }, 500);
    return;
  }
  // Destroy existing Sortable instance if any
  if (cardsContainer.sortableInstance) {
    cardsContainer.sortableInstance.destroy();
    cardsContainer.sortableInstance = null;
  }
  // Create new Sortable instance
  // Only allow dragging items with class 'draggable-item' (excludes first item)
  try {
    const sortable = new Sortable(cardsContainer, {
      animation: 150,
      draggable: '.draggable-item',
      filter: function(evt, item) {
        // Prevent dragging first child (which doesn't have draggable-item class)
        return item === cardsContainer.firstElementChild;
      },
      preventOnFilter: true,
      forceFallback: false,
      swapThreshold: 0.65,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen'
    });
    // Store instance for later cleanup
    cardsContainer.sortableInstance = sortable;
    console.log('Sortable initialized successfully');
  } catch (error) {
    console.error('Error initializing Sortable:', error);
  }
}

function renderQuestion2(questionlist) {
  correctAnswersQuestion2 = [];
  questionlist.forEach(item => { correctAnswersQuestion2.push(item); });
  // Keep first sentence fixed at index 0, shuffle the rest
  const firstSentence = questionlist[0];
  const restSentences = questionlist.slice(1);
  const shuffledRest = shuffleQuestions([...restSentences]);
  const shuffledQuestionlist = [firstSentence, ...shuffledRest];
  const cardsContainer = document.getElementById('cardsContainer');
  if (cardsContainer) {
    cardsContainer.innerHTML = '';
    shuffledQuestionlist.forEach((text, index) => {
      const cardDiv = document.createElement('div');
      if (index === 0) {
        // First sentence: fixed, not draggable, with checkmark and highlight
        cardDiv.classList.add('card', 'mb-2');
        cardDiv.style.backgroundColor = '#e3f2fd';
        cardDiv.style.border = '2px solid #1976d2';
        cardDiv.style.cursor = 'default';
        const cardBody = document.createElement('div');
        cardBody.classList.add('card-body', 'd-flex', 'align-items-center');
        const checkIcon = document.createElement('i');
        checkIcon.classList.add('bi', 'bi-check-circle-fill', 'text-success', 'me-2');
        checkIcon.style.fontSize = '1.2rem';
        cardBody.appendChild(checkIcon);
        const textSpan = document.createElement('span');
        textSpan.innerText = text;
        cardBody.appendChild(textSpan);
        cardDiv.appendChild(cardBody);
      } else {
        // Other sentences: draggable
        cardDiv.classList.add('card', 'mb-2', 'draggable-item');
        // Don't set draggable attribute - SortableJS handles dragging
        cardDiv.id = 'item' + (index + 1);
        const cardBody = document.createElement('div');
        cardBody.classList.add('card-body', 'd-flex', 'align-items-center');
        const dragIcon = document.createElement('i');
        dragIcon.classList.add('bi', 'bi-grip-vertical', 'me-2', 'text-muted');
        dragIcon.style.fontSize = '1.2rem';
        cardBody.appendChild(dragIcon);
        const textSpan = document.createElement('span');
        textSpan.innerText = text;
        cardBody.appendChild(textSpan);
        cardDiv.appendChild(cardBody);
      }
      cardsContainer.appendChild(cardDiv);
    });
    // Initialize Sortable after a short delay to ensure DOM is ready and SortableJS is loaded
    setTimeout(function() {
      initSortable();
    }, 200);
  }
  const headerEl = document.getElementById('html_questheader');
  if (headerEl) headerEl.textContent = 'Reading Question 2 & 3 ( ' + (currentSetIndex + 1) + ' / ' + questheader.length + ' )';
  const topicEl = document.getElementById('question2_topic');
  if (topicEl) topicEl.textContent = 'Topic: ' + questheader[currentSetIndex];
}
// Expose renderQuestion2 to window
window.renderQuestion2 = renderQuestion2;

// User answers array
const userAnswersQuestion2 = [];
let question2Score = 0;

// Check result button handler
document.getElementById('checkResultButton').addEventListener('click', function() {
  userAnswersQuestion2.length = 0;
  const cardsContainer = document.getElementById('cardsContainer');
  // Get all cards including the first one (which is not draggable)
  const cards = cardsContainer.querySelectorAll('.card');
  cards.forEach((card) => {
    // Get text content, removing icon text if present
    const cardBody = card.querySelector('.card-body');
    if (cardBody) {
      const textSpan = cardBody.querySelector('span');
      const selectedAnswer = textSpan ? textSpan.textContent.trim() : cardBody.textContent.trim().replace(/^[✓\s]*/, '').trim();
      userAnswersQuestion2.push(selectedAnswer || "(không chọn)");
    } else {
      const selectedAnswer = card.textContent.trim() || "(không chọn)";
      userAnswersQuestion2.push(selectedAnswer);
    }
  });
  const answers = [];
  const correctAnswers = [];
  correctAnswersQuestion2.forEach((correctAnswer, index) => {
    const selectedAnswer = userAnswersQuestion2[index] || "(không chọn)";
    answers.push(selectedAnswer);
    correctAnswers.push(correctAnswer);
  });
  question2Score = displayComparisonResultsQuestion2(answers, correctAnswers);
  const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
  resultModal.show();
});

// Display comparison results function
function displayComparisonResultsQuestion2(userAnswers, correctAnswers) {
  const comparisonBody = document.getElementById('comparisonTableBody');
  const totalScoreElement = document.getElementById('totalScore');
  comparisonBody.innerHTML = '';
  let score = 0;
  userAnswers.forEach((userAnswer, index) => {
    const tr = document.createElement('tr');
    const userAnswerTd = document.createElement('td');
    userAnswerTd.innerHTML = '<span class="' + (userAnswer === correctAnswers[index] ? 'correct' : 'incorrect') + '">' + userAnswer + '</span>';
    tr.appendChild(userAnswerTd);
    const correctAnswerTd = document.createElement('td');
    correctAnswerTd.innerHTML = '<span class="correct">' + correctAnswers[index] + '</span>';
    tr.appendChild(correctAnswerTd);
    if (userAnswer === correctAnswers[index]) score++;
    comparisonBody.appendChild(tr);
  });
  totalScoreElement.innerHTML = '<strong>Your score: ' + score + ' / ' + correctAnswers.length + '</strong>';
  return score;
}

// Next button handler
document.getElementById('nextButton').addEventListener('click', function() {
  const nextBtn = document.getElementById('nextButton');
  if (currentSetIndex < questionSets.length - 1) {
    currentSetIndex++;
    renderQuestion2(questionSets[currentSetIndex]);
    if (currentSetIndex === questionSets.length - 1 && nextBtn) {
      nextBtn.textContent = "The end";
    }
  } else if (nextBtn && nextBtn.textContent === 'The end') {
    // Khi đã xong toàn bộ bộ đề upload (Reading Question 2 & 3) -> quay về trang chọn bài Reading
    window.location.href = 'reading_question.html';
  }
});

// Back button handler
document.getElementById('backButton').addEventListener('click', function() {
  if (currentSetIndex > 0) {
    currentSetIndex--;
    renderQuestion2(questionSets[currentSetIndex]);
    if (currentSetIndex !== questionSets.length - 1) {
      document.getElementById('nextButton').textContent = "Next";
    }
  }
});

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    if (questionSets && questionSets.length > 0) renderQuestion2(questionSets[0]);
  });
} else {
  if (questionSets && questionSets.length > 0) renderQuestion2(questionSets[0]);
}


/* MINI_HIPPO_LESSON_DATA_START
{
  "version": 1,
  "lessonType": "reading",
  "part": "2",
  "sets": [
    {
      "id": 1,
      "title": "READING EXTRA P2",
      "data": {
        "topic": "Đề dự phòng thêm: Tech Innovation Expo",
        "sentences": [
          "The tech expo was held on Sunday morning, showcasing cutting-edge innovations.",
          "Over 75 participants attended, with Ms. Tran presenting a smart home device.",
          "After the presentations, awards were given for the most creative prototype.",
          "Activities included 3D printing demos, Al workshops, and virtual reality trials.",
          "Attendees enjoyed networking over coffee and exploring interactive displays."
        ]
      }
    },
    {
      "id": 2,
      "title": "READING EXTRA P2-2",
      "data": {
        "topic": "Music festivals",
        "sentences": [
          "0. Last Saturday, a live music show was held in town park",
          "The local government planned, funded and paid for everything",
          "Because it was free, more than 5,000 people attended",
          "People came early and sat in nearby shops waiting for the start time",
          "The staff were very busy but still closed the shop early to watch the singer",
          "The singer performed for 2 hours, everyone had great fun."
        ]
      }
    },
    {
      "id": 3,
      "title": "READING EXTRA P2-3",
      "data": {
        "topic": "Family sports day",
        "sentences": [
          "0. Last week, the weather was great. The town organized a ten-mile race.",
          "It took place on Sunday morning in the park, there was a race for adults.",
          "Sixty people took part, and among them, Ms. Kamus kept the fastest pace and won the race.",
          "After she got her prize, children's activities and competitions began.",
          "The activities were football, swimming, skipping, and more, and the kids had fun playing together.",
          "After the games, the kids were really hungry and ate with their parents."
        ]
      }
    },
    {
      "id": 4,
      "title": "READING EXTRA P2-4",
      "data": {
        "topic": "Means of transportation",
        "sentences": [
          "In the past, transportation was primarily accessible to the wealthy.",
          "Later, air travel became popular among business professionals.",
          "Eventually, buses and trains were introduced as affordable alternatives.",
          "These made traveling more accessible to everyone.",
          "Today, buses and trains are among the most common transportation options."
        ]
      }
    },
    {
      "id": 5,
      "title": "READING EXTRA P2-5",
      "data": {
        "topic": "A new coffee shop (2)",
        "sentences": [
          "I arrived at the shop early in the morning, but it was crowded with people.",
          "A waiter assisted me in finding a table and handed me the menu.",
          "The menu was not as good as expected and quite pricey, so I decided to order a sandwich.",
          "The sandwich was both delicious and beautifully presented.",
          "I might return to try different types of drinks next time."
        ]
      }
    },
    {
      "id": 6,
      "title": "READING EXTRA P2-6",
      "data": {
        "topic": "Making films",
        "sentences": [
          "0. In 1895, the Grand Place cafe in France showed the first commercial film.",
          "Old movies were very different from today's movies.",
          "That's because the movies were only in black and white, and sometimes without sound.",
          "Not only did these technological limitations exist, the movies were also low budget.",
          "Due to the lack of money, actors also had few opportunities to earn money through acting.",
          "Now things have changed, actors and filmmakers can earn millions of dollars from film production."
        ]
      }
    },
    {
      "id": 7,
      "title": "READING EXTRA P2-7",
      "data": {
        "topic": "Tech fair",
        "sentences": [
          "The tech fair took place on Saturday morning, showcasing a variety of exciting new gadgets.",
          "More than 60 exhibitors participated, with Mr. A presenting an impressive robot demonstration.",
          "The event featured engaging activities such as VR gaming, coding workshops, and thrilling drone races.",
          "After the demonstrations, awards were given to the creators of the most innovative products.",
          "Visitors enjoyed complimentary coffee and snacks while exploring the interactive exhibits."
        ]
      }
    },
    {
      "id": 8,
      "title": "READING EXTRA P2-8",
      "data": {
        "topic": "The famous singer (2)",
        "sentences": [
          "He is a famous singer.",
          "Before becoming famous, he studied music at school when he was 15.",
          "His unique way of dressing and performing made him stand out from others.",
          "This helped him receive many invitations for collaborations and performances.",
          "He eventually became famous among audiences around the world."
        ]
      }
    },
    {
      "id": 9,
      "title": "READING EXTRA P2-9",
      "data": {
        "topic": "The famous singer (3)",
        "sentences": [
          "Jaden Nobelton is only 18 years old and he is a famous singer",
          "Before becoming famous at his age, he studied art and music in high school.",
          "During his studies, he studied creativity and singing on stage.",
          "In these performances, he often wears bright clothes and paints his face.",
          "The uniqueness in his way of dressing and his songs makes him attract attention.",
          "Many people follow him on social media and he becomes a famous singer."
        ]
      }
    },
    {
      "id": 10,
      "title": "READING EXTRA P2-10",
      "data": {
        "topic": "Writing about a place (2)",
        "sentences": [
          "Before writing, it is important to research the place thoroughly.",
          "To prepare well, you should learn about the people and the history of the area.",
          "Sometimes you may not be able to visit the place, but you can still find similar information from other sources.",
          "Comparing that place with your own country can be very helpful.",
          "This comparison will help you gain a deeper understanding and write more effectively."
        ]
      }
    },
    {
      "id": 11,
      "title": "READING EXTRA P2-11",
      "data": {
        "topic": "My visit to a new coffee shop",
        "sentences": [
          "It was my first time visiting a new local coffee shop.",
          "At first, I didn’t think it would be good, but I decided to give it a try.",
          "I looked at the menu and saw many different kinds of food and drinks.",
          "I chose one dish to try for myself.",
          "When I tasted it, I found it really delicious and knew I would come back again."
        ]
      }
    },
    {
      "id": 12,
      "title": "READING EXTRA P2-12",
      "data": {
        "topic": "History to travel",
        "sentences": [
          "In the past, only very rich people could afford to travel long distances.",
          "The invention of cars and trains had changed everything and made travelling cheaper.",
          "After these two means of transport, travelling becomes even easier with aeroplanes.",
          "Because flying with them is so fast, more people now go abroad for holiday and business.",
          "It is more convenient to travel to other part of the world due to the improvement in transports"
        ]
      }
    },
    {
      "id": 13,
      "title": "READING EXTRA P2-13",
      "data": {
        "topic": "University open day",
        "sentences": [
          "Before the open day, please contact us by phone or email so we can record your personal details.",
          "Using this information, we’ll prepare an identification card for you to collect upon arrival.",
          "You’ll need to show this card to enter the introductory talk and morning lectures.",
          "Every visitor will have the chance to join a Q&A session with current students.",
          "After the presentations, you’ll be able to explore different departments across the campus."
        ]
      }
    }
  ]
}
MINI_HIPPO_LESSON_DATA_END */
